---
id: REQ-098
title: "Create spend estimation validation script"
status: completed
created_at: 2026-02-16T12:00:00-08:00
user_request: UR-031
claimed_at: 2026-02-16T20:00:00-08:00
route: B
completed_at: 2026-02-16T20:41:00-08:00
related: [REQ-095, REQ-096, REQ-097, REQ-099]
batch: "security-phase-3"
source_step: "3.1"
source_doc: "docs/security-TODO.md"
blueprint_ref: "docs/security-BLUEPRINT.md"
model_hint: "Codex/Opus"
---

# Create spend estimation validation script (Step 3.1)

## What
Create a lightweight validation script that reads the app's estimated spend from Firestore and prints a comparison report, including pricing constants and instructions for checking actual GCP billing.

## Checklist
- [x] **[Codex/Opus]** Create `web/scripts/validate-spend.ts`
  - Reads Firestore `spendMonthly/{YYYY-MM}` document
  - Prints: estimated spend, budget, % used, pricing constants
  - Prints: GCP Billing console URL for comparison
  - Includes `LAST_PRICING_REVIEW` date; warns if stale >30 days
- [x] **[Codex/Opus]** Add `"validate-spend"` script to `web/package.json`
- [x] **[Codex/Opus]** TEST: Run `npm run lint` — no lint errors
- [x] **[Codex/Opus]** TEST: Run `npm run validate-spend` with GCP credentials — output is clear and correct

## Blueprint Guidance
### 3.1 Create spend estimation validation script

- **Goal**: Provide a way to compare the app's estimated spend (Firestore `spendMonthly` doc) against actual GCP billing, so pricing drift can be detected.
- **Files to create**:
  - `web/scripts/validate-spend.ts` — reads current month's Firestore spend doc and prints it alongside instructions for checking actual GCP billing.
- **Design**:
  - Read the `spendMonthly/{YYYY-MM}` Firestore document.
  - Print: estimated spend, budget, percentage used, and the hardcoded pricing constants.
  - Print: instructions to compare against GCP Billing console (with a direct URL).
  - Print: a warning if the pricing constants haven't been reviewed in >30 days (based on a `LAST_PRICING_REVIEW` constant in the script).
- **Acceptance criteria**:
  - Script runs with `npx tsx web/scripts/validate-spend.ts`.
  - Output is clear and actionable.
  - No secrets are printed.
- **Test plan**:
  - Run the script locally with GCP credentials.
  - Verify the output includes the expected fields.
- **Prompt**:

```text
Create web/scripts/validate-spend.ts.

This script reads the current month's spend tracking from Firestore and prints a comparison report.

Requirements:
- Import from the existing spend-cap.ts module to reuse types and constants.
- Read spendMonthly/{YYYY-MM} from Firestore.
- Print: estimated spend, budget, % used, pricing constants.
- Print a URL to the GCP Billing console for the project.
- Include a LAST_PRICING_REVIEW date constant; warn if >30 days stale.
- Add a "validate-spend" script to web/package.json.

No unit tests needed (this is a manual validation script).
Run: npm run lint.
```

## Context
- **Document set**: security
- **Phase**: 3 — Cost Validation Script (F7)
- **Specification**: See docs/security-SPECIFICATION.md for full requirements
- **Model recommendation**: Codex/Opus (advisory — use if your tool supports model selection)

## Dependencies
Independent of Phases 1 and 2 — can run in parallel.

---
*Source: docs/security-TODO.md, Step 3.1*

---

## Triage

**Route: B** - Medium

**Reasoning:** Clear feature with a detailed prompt, but need to find the existing spend-cap.ts module to reuse its types and constants, and understand Firestore admin initialization patterns.

**Planning:** Not required

## Plan

**Planning not required** - Route B: Exploration-guided implementation

Rationale: Clear feature with detailed blueprint guidance. Just need to discover existing spend-cap.ts exports and Firestore admin patterns.

*Skipped by work action*

## Exploration

- **spend-cap.ts** at `web/src/lib/spend-cap.ts` — exports: `SPEND_CAP_USD` (20), `COST_PER_1K_INPUT_TOKENS_USD` (0.00125), `COST_PER_1K_OUTPUT_TOKENS_USD` (0.00375), `MIN_COST_PER_CALL_USD` (0.001), `DEFAULT_MONTHLY_BUDGET_USD`, `getMonthKeyForDate()`, `getRemainingBudget()`, `isSpendCapExceeded()`, `getSpendStatus()`
- **SpendMonthlyDoc** type in `web/src/lib/firestore.ts`: `{ usdBudget: number, usdUsedEstimated: number, updatedAt: Timestamp }`
- **Firestore init pattern** in scripts: `new Firestore({ projectId: env.GCP_PROJECT_ID })` after loading `.env.local` with dotenv
- **Existing scripts** in `web/scripts/`: `seed-resume.ts`, `validate-resume.ts`, `smoke-gcp.ts` — all use dotenv + zod env validation pattern
- **Package.json scripts**: `"seed:resume"`, `"validate:resume"`, `"smoke:gcp"` — all use `npx tsx scripts/...`
- **GCP project ID**: `samkirk-v3` (from `.env.local`)
- **Billing URL**: `https://console.cloud.google.com/billing/projects/samkirk-v3`

*Generated by Explore agent*

## Implementation Summary

- Created `web/scripts/validate-spend.ts` — reads Firestore `spendMonthly/{YYYY-MM}`, prints spend report with budget/remaining/%, pricing constants, staleness warning, and GCP billing URL
- Constants duplicated from `spend-cap.ts` (server-only guard prevents direct import in tsx scripts)
- Added `"validate:spend": "npx tsx scripts/validate-spend.ts"` to `web/package.json`

*Completed by work action (Route B)*

## Testing

**Tests run:** `npm run lint` and `npm run validate:spend`
**Result:** ✓ Lint clean (no new errors), script runs successfully with GCP credentials

**Lint:** Pre-existing errors in `hire-me/page.tsx` only — new script has zero lint issues
**Script output verified:** Estimated spend ($2.4740), budget ($20.00), 12.37% used, pricing constants, staleness check (1 day), billing URL all displayed correctly

*Verified by work action*
