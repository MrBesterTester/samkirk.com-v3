---
id: REQ-072
title: "Addendum: chunk references still leaking in chat"
status: completed
created_at: 2026-02-14T10:50:00Z
user_request: UR-013
addendum_to: REQ-070
claimed_at: 2026-02-14T11:00:00Z
route: B
completed_at: 2026-02-14T11:09:00Z
---

# Addendum: Chunk references still leaking in chat

## What
REQ-070 added `stripChunkReferences()` but the regex pattern doesn't cover all formats. The LLM is outputting `(chunks 1, 8, 12, 23, 33)` — plural "chunks" with bare numbers — which doesn't match the regex `\(chunk_[\w]+(?:,\s*chunk_[\w]+)*\)` that expects `chunk_` prefix with underscores.

## Context
- REQ-070 (completed) added a strip utility and prompt instruction in `src/lib/interview-chat.ts`
- The regex handles `(chunk_abc123, chunk_def456)` format but NOT:
  - `(chunks 1, 8, 12, 23, 33)` — plural, bare numbers
  - `(chunk 1, chunk 2)` — no underscore
  - Other variations the LLM might produce
- The regex needs to be broadened to catch all chunk reference patterns
- The system prompt instruction may also need strengthening

---
*Source: still getting chunk references in the dialog. Addendum to REQ-070 (completed).*

---

## Triage

**Route: B** - Medium

**Reasoning:** Clear bug fix (broaden regex), but need to explore the current implementation to see all patterns and the system prompt instruction.

**Planning:** Not required

## Plan

**Planning not required** - Route B: Exploration-guided implementation

Rationale: Clear fix needed for regex pattern, just need to see the current implementation and understand what patterns to cover.

*Skipped by work action*

## Exploration

- `stripChunkReferences()` at `web/src/lib/interview-chat.ts:110` — regex `\(chunk_[\w]+(?:,\s*chunk_[\w]+)*\)` only handles `chunk_` prefix format
- Called at line 648: `assistantContent = stripChunkReferences(result.text)`
- System prompt at line 243 mentions `chunk_abc123` format but not bare number formats
- Chunk IDs generated in `web/src/lib/resume-context.ts:68-90` as `chunk_abc123` format
- Tests at `web/src/lib/interview-chat.test.ts:138-194` (13 tests) — none cover `chunks 1, 8` or `chunk 1` patterns
- Integration test at line 582-602 only checks `chunk_` format

*Generated by Explore agent*

## Implementation Summary

- Replaced single regex with three specific, case-insensitive patterns:
  - Pattern 1: `(chunk_abc123)` — original underscore format (preserved)
  - Pattern 2: `(chunks 1, 8, 12)` — plural with bare numbers (new)
  - Pattern 3: `(chunk 1, chunk 2)` — singular with bare numbers (new)
- Strengthened system prompt to explicitly mention bare-number formats
- Added 10 new test cases covering all new patterns + negative cases for legitimate parentheticals

*Completed by work action (Route B)*

## Testing

**Tests run:** `npx vitest run src/lib/interview-chat.test.ts`
**Result:** 67/67 passing

**New tests added:**
- Plural chunks with bare numbers `(chunks 1, 8, 12, 23, 33)`
- Single bare number after chunks `(chunks 5)`
- Singular chunk with bare number `(chunk 1)`
- Multiple singular chunk bare-number refs `(chunk 1, chunk 2, chunk 3)`
- Capitalised variants `(Chunk 5)`, `(Chunks 1, 2, 3)`
- Mixed underscore and bare-number formats
- Negative cases: tech stacks, date ranges, team sizes preserved

*Verified by work action*
