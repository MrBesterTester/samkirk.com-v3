---
id: REQ-078
title: Investigate and purge stale/incorrect chunks from vector database
status: completed
created_at: 2026-02-14T13:00:00Z
user_request: UR-019
claimed_at: 2026-02-14T13:05:00Z
route: B
completed_at: 2026-02-14T13:25:00Z
---

# Investigate and purge stale/incorrect chunks from vector database

## What
The vector database contains stale or incorrect chunks that are producing fabricated education history in custom resumes. A downloaded custom resume package (custom-resume-Q470b135s6xkpXymNPyRxw.zip) included completely wrong education data — Stanford, UC Berkeley, University of Louisville, Ohio State — none of which are correct.

## Context
- The Custom Resume function generated a resume with fabricated education entries
- Education listed: MS CS Stanford 2014, BS CS UC Berkeley 2012, MS Applied Math Louisville 1982, BA Philosophy/Math Ohio State 1973
- None of these are the user's actual education
- Root cause is likely old/incorrect chunks persisted in the vector database from previous resume versions, test data, or sample data
- Need to audit the vector DB for stale chunks and purge anything that doesn't belong to the current resume data
- May also need to re-index the current resume to ensure clean data

---
*Source: In my downloads folder there is donwload package from the Custom Resume function, custom-resume-Q470b135s6xkpXymNPyRxw.zip, which has really screwed up my education. It looks like there are old chunks in the vector database that don't belong there.*

---

## Triage

**Route: B** - Medium

**Reasoning:** Clear objective (audit and purge stale vector DB chunks) but need to explore how chunks are stored, what vector DB is used, and how to inspect/delete entries.

**Planning:** Not required

## Plan

**Planning not required** - Route B: Exploration-guided implementation

Rationale: The goal is clear — find and remove incorrect chunks from the vector database. Need to explore the vector DB setup and chunking infrastructure to understand how to inspect and purge entries.

*Skipped by work action*

## Exploration

- **Database**: Google Cloud Firestore (not a traditional vector DB). Collections: `resumeIndex` (metadata) and `resumeChunks` (chunk docs with `version` field)
- **Retrieval**: `getCurrentChunks()` in `resume-chunker.ts:545-568` reads current version from `resumeIndex/current`, queries `resumeChunks` where `version == currentVersion`
- **Root cause**: `smoke-gcp.ts` sections 11 and 12 write test chunks with versions 9997/9996 containing fabricated education (Stanford, UC Berkeley) and certifications. They overwrite `resumeIndex/current` but don't properly restore it:
  - On success: DELETE the index instead of restoring → system has no index
  - On failure: Leave test version in place → system serves fake data
- **Secondary issue**: `seed-resume.ts` only purges `previousVersion` chunks, so orphaned test chunks from other versions persist
- **Correct education** is in `data/baseline-resume.md`: University of Louisville (MS 1982), Ohio State (BA 1973)
- **Seed script**: `npm run seed:resume` re-indexes from baseline resume

*Generated by Explore agent*

## Implementation Summary

### Fix 1: `web/scripts/seed-resume.ts` — Full purge on re-index
- Replaced version-filtered deletion (`where("version", "==", previousVersion)`) with full collection purge (delete ALL documents in `resumeChunks` regardless of version)
- Version now always resets to 1 instead of incrementing from stale values
- `npm run seed:resume` is now a complete database reset

### Fix 2: `web/scripts/smoke-gcp.ts` Section 11 — Save/restore resumeIndex
- Added `originalIndexSnapshot11` save before the try block
- Success path: restores original index data instead of deleting
- Error path: restores original index data in catch block

### Fix 3: `web/scripts/smoke-gcp.ts` Section 12 — Save/restore resumeIndex
- Same pattern as Section 11 using `resumeIndexRef12`/`originalIndexData12`
- Both success and error cleanup paths now restore the original index

### User action required
Run `cd web && npm run seed:resume` to purge stale test chunks and re-index from the correct baseline resume.

*Completed by work action (Route B)*

## Testing

**Tests run:** `npx vitest run src/lib/resume-chunker.test.ts`
**Result:** All 49 tests passing

**TypeScript check:** `npx tsc --noEmit` — no errors in modified files (pre-existing errors only in unrelated test files)

**No new tests added** — changes are to operational scripts (seed/smoke), not to library code. The smoke test itself IS the test for the save/restore behavior.

*Verified by work action*
