---
id: REQ-053
title: "Add --json flag"
status: completed
created_at: 2026-02-13T18:00:00Z
user_request: UR-007
claimed_at: 2026-02-13T21:00:00Z
route: B
completed_at: 2026-02-13T21:08:00Z
related: [REQ-043]
batch: "test-results-phase-3"
source_step: "3.6"
source_doc: "docs/test-results-TODO.md"
blueprint_ref: "docs/test-results-BLUEPRINT.md"
model_hint: "Sonnet 4"
---

# Add --json flag (Step 3.6)

## What
Add `--json` flag that outputs the parsed test summary as a machine-readable JSON object containing frontmatter, suite results, and fixture updates.

## Checklist
- [x] Output parsed summary as JSON object (frontmatter + suite results + fixture updates)
- [x] TEST: `npm run test:results -- --json | node -e "JSON.parse(require('fs').readFileSync(0,'utf8'))"`

## Blueprint Guidance

| Flag | Behavior |
|------|----------|
| `--json` | Output parsed summary as JSON |

## Context
- **Document set**: test-results
- **Phase**: 3 — Remaining Viewer Flags
- **Blueprint**: See docs/test-results-BLUEPRINT.md for full design
- **Model recommendation**: Sonnet 4 (advisory — use if your tool supports model selection)

## Dependencies
Depends on REQ-043 (core viewer with all parse functions). Phase 1 must be complete.

---
*Source: docs/test-results-TODO.md, Step 3.6*

---

## Triage

**Route: B** - Medium

**Reasoning:** Clear feature (--json flag) but need to explore existing parse functions and data structures to output the right JSON shape.

**Planning:** Not required

## Plan

**Planning not required** - Route B: Exploration-guided implementation

Rationale: The --json flag has a well-defined outcome (JSON output of parsed data). Just need to discover existing parse functions and their return types.

*Skipped by work action*

## Exploration

- Main script: `web/scripts/test-results.ts` (817 lines)
- CLI already parses `--json` → `args.json: boolean` (line 120), stub at lines 758-761
- Parse functions available: `parseSummaryFrontmatter()` → `SummaryFrontmatter | null`, `parseSummaryTable()` → `SuiteRow[]`, `parseFixtureUpdates()` → `FixtureUpdate[]`, `parseTestIndex()` → `TestIndexRow[]`
- SummaryFrontmatter: {timestamp, suites_run, overall, gcp_available, triggered_by, release_candidate}
- SuiteRow: {name, status, passed, failed, skipped, duration}
- FixtureUpdate: {file, suite, type: "created"|"updated"}
- TestIndexRow: {path, describes}
- Default flow reads summary.md at line 774, parses all sections
- JSON output shape should include: frontmatter, suites, fixture_updates, and optionally test_index
- Use `console.log(JSON.stringify(obj, null, 2))` for output

*Generated by Explore agent*

## Implementation Summary

- Replaced --json stub with full implementation
- Respects --run flag for archive selection, falls back to latest
- Parses frontmatter, suite table, and fixture updates from summary.md
- Outputs JSON with shape: { frontmatter, suites, fixture_updates, archive: { directory, path } }
- Pretty-printed with 2-space indentation

*Completed by work action (Route B)*

## Testing

**Tests run:** `npx tsx scripts/test-results.ts --json | node -e "JSON.parse(require('fs').readFileSync(0,'utf8'))"`
**Result:** Valid JSON output confirmed

*Verified by work action*
