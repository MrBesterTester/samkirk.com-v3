---
id: REQ-045
title: "Add fixture snapshot functions"
status: completed
created_at: 2026-02-13T18:00:00Z
user_request: UR-007
claimed_at: 2026-02-13T18:21:00Z
route: B
completed_at: 2026-02-13T18:30:00Z
related: [REQ-046, REQ-047]
batch: "test-results-phase-2"
source_step: "2.1"
source_doc: "docs/test-results-TODO.md"
blueprint_ref: "docs/test-results-BLUEPRINT.md"
model_hint: "Opus 4.5"
---

# Add fixture snapshot functions (Step 2.1)

## What
Add fixture mtime tracking functions to `web/scripts/test-all.ts` so that test run summaries can record which fixtures were created or updated during a run.

## Checklist
- [x] Add `snapshotFixtureMtimes()` — walk `web/test-fixtures/` recursively, return `Map<string, number>`
- [x] Add `diffFixtureMtimes()` — compare before/after snapshots, return changed files with type (created/updated)
- [x] Add `attributeSuiteToFixture()` — use suite start/end timestamps for attribution
- [x] Add `fixtureUpdates` field to `ArchiveOptions` interface

## Blueprint Guidance

### 2. Modify: `web/scripts/test-all.ts` (+~80 lines)

Add fixture mtime tracking so summary.md records which fixtures were updated.

**Before suites run** (~line 1000): snapshot mtimes of all files in `web/test-fixtures/` recursively via a new `snapshotFixtureMtimes()` function (~20 lines).

**After suites complete** (~line 1038): diff mtimes via `diffFixtureMtimes()` (~25 lines). Attribute each changed fixture to the suite that was running when it changed (suites run sequentially, so timestamp windows are unambiguous).

Changes to `ArchiveOptions` interface (line 817): add `fixtureUpdates` field.

## Context
- **Document set**: test-results
- **Phase**: 2 — Fixture Mtime Tracking in Test Runner
- **Blueprint**: See docs/test-results-BLUEPRINT.md for full design
- **Model recommendation**: Opus 4.5 (advisory — use if your tool supports model selection)

## Dependencies
Independent of Phase 1 (viewer script). REQ-046 and REQ-047 depend on these functions.

---
*Source: docs/test-results-TODO.md, Step 2.1*

---

## Triage

**Route: B** - Medium

**Reasoning:** Clear functions to add, but need to explore test-all.ts structure — ArchiveOptions interface, where suites run, and existing patterns.

**Planning:** Not required

## Plan

**Planning not required** - Route B: Exploration-guided implementation

Rationale: Functions are well-defined in the blueprint. Need to find the right insertion points in the ~1000-line test-all.ts.

*Skipped by work action*

## Exploration

- ArchiveOptions interface at lines 816-824: results, ref, release, noArchive, gcpAvailable, testIndex
- SuiteResult interface at lines 54-71: name, status, passed, failed, skipped, durationMs, skipReason, output
- Main suite loop at lines 1004-1022: sequential for loop over `toRun`, calls `runSuite()`
- runSuite() at lines 419-490: tracks startTime=Date.now(), durationMs=Date.now()-startTime
- writeArchive() at lines 827-945: builds summary.md with frontmatter, table, test index, verifications
- Fixtures at web/test-fixtures/ with subdirs: resume-generator/, interview-chat/, fit-report/
- Existing timestamp helpers: toPstIso(), toPstHuman(), toPstDirName()
- Suite slug helpers: suiteSlug(), suiteFlagSlug()

*Generated by Explore agent*

## Implementation Summary

- Added `FixtureUpdate` interface (file, suite, type fields)
- Added `snapshotFixtureMtimes()` — recursively walks web/test-fixtures/, returns Map<string, number>
- Added `diffFixtureMtimes()` — compares before/after snapshots, returns created/updated diffs
- Added `attributeSuiteToFixture()` — correlates diffs with suite timing windows
- Extended `ArchiveOptions` interface with `fixtureUpdates: FixtureUpdate[]`
- Updated writeArchive call site to pass `fixtureUpdates: []` (wiring deferred to REQ-047)
- Added `relative` to path import, `statSync` to fs import

*Completed by work action (Route B)*

## Testing

**Tests run:** `npx tsc --noEmit --skipLibCheck`
**Result:** ✓ No new TypeScript errors (all errors pre-existing in test files)

*Verified by work action*
