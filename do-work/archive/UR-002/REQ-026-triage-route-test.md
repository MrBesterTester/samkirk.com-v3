---
id: REQ-026
title: "Triage route.test.ts tests (3 tests)"
status: completed
created_at: 2026-02-06T12:00:00-08:00
user_request: UR-002
claimed_at: 2026-02-06T20:42:00-08:00
route: B
completed_at: 2026-02-06T20:50:00-08:00
commit: e0ce325
source_step: "5.1"
source_doc: "docs/master-test-TODO.md"
blueprint_ref: "docs/master-test-BLUEPRINT.md"
model_hint: "Opus 4.5"
batch: "master-test-phase-5"
related: [REQ-027]
---

# Triage route.test.ts tests (3 tests) (Step 5.1)

## What
Evaluate the 3 pre-existing test failures in `route.test.ts` and implement triage decisions (keep, rewrite, or delete) for each test. Follow the guiding principles in the SPECIFICATION.

## Checklist
- [x] Evaluate test #1 ("serve existing file") — overlap with smoke-gcp Section 1?
- [x] Evaluate test #2 ("return 404") — candidate for mock-based rewrite?
- [x] Evaluate test #3 ("block traversal") — convert to pure unit test
- [x] Implement triage decisions (keep/rewrite/delete per test)
- [x] TEST: `npm run test:all` — no regressions after triage

## Blueprint Guidance
- **Goal**: Evaluate tests #1-3 from the pre-existing failure inventory
- **Inventory**:

| # | Test Name | Failure Mode | Notes |
|---|-----------|-------------|-------|
| 1 | "should serve existing file from GCS via proxy" | `invalid_rapt` — GCP auth | Real GCS integration test. May duplicate `smoke-gcp.ts` Section 1 (Cloud Storage). Decide: keep as integration test, or convert to mock-based unit test. |
| 2 | "should return 404 for missing file" | Same GCP auth failure | Tests route handler 404 logic. Could be tested with a mocked storage client. |
| 3 | "should block directory traversal attempts" | Same GCP auth failure | Tests input validation. **Does not need GCS at all** — the traversal check happens before any GCS call. Strong candidate for converting to pure unit test. |

- **Triage questions for each**:
  1. Does another test already cover this? (smoke-gcp sections, dedicated tool spec files)
  2. Can the test be rewritten to not need GCP? (mock the storage/firestore client)
  3. Is the test valuable enough to keep as a GCP-required integration test?
  4. Should it be deleted? (if fully duplicated elsewhere)
- **Expected outcomes**:
  - Test #3 (directory traversal): Convert to pure unit test — no GCS needed
  - Tests #1-2: Evaluate overlap with `smoke-gcp.ts` Section 1

## Context
- **Document set**: master-test
- **Phase**: 5 — Triage (Task B)
- **Specification**: See docs/master-test-SPECIFICATION.md Section 6 (Guiding Principles for Triage)
- **Model recommendation**: Opus 4.5 for evaluation, Gemini 3 Pro for testing (advisory)

## Dependencies
Depends on Phases 1-4 being complete (skip guards in place, runner working). Phase 5 steps are independent of each other.

---
*Source: docs/master-test-TODO.md, Step 5.1*

---

## Triage

**Route: B** - Medium

**Reasoning:** Clear triage task with defined tests to evaluate, but need to explore route.test.ts, smoke-gcp.ts, and the route handler to understand overlap and make informed decisions.

**Planning:** Not required

## Plan

**Planning not required** - Route B: Exploration-guided implementation

Rationale: Well-defined evaluation task with specific tests listed. Need to explore the codebase to understand overlap before making triage decisions.

*Skipped by work action*

## Exploration

- **route.test.ts**: `web/src/app/api/public/[...path]/route.test.ts` (81 lines, 3 tests)
- **Route handler**: `web/src/app/api/public/[...path]/route.ts` — traversal check on line 20 (before GCS calls), then fileExists/getMetadata/download
- **smoke-gcp.ts**: Section 1 tests direct GCS SDK on private bucket — complementary but not duplicative of the proxy route tests
- **Triage decisions**:
  - Test #1 (serve file): KEEP — tests full proxy pipeline with HTTP headers, not duplicated by smoke-gcp
  - Test #2 (404): KEEP — tests route-specific error handling, not covered elsewhere
  - Test #3 (traversal): REWRITE — security check happens before GCS calls, no credentials needed

*Generated by Explore agent*

## Implementation Summary

- **Test #1 ("serve existing file")**: Kept as-is with GCP skip guard — not duplicated by smoke-gcp (different bucket, tests HTTP layer)
- **Test #2 ("return 404")**: Kept as-is with GCP skip guard — unique route error handling coverage
- **Test #3 ("block traversal")**: Rewritten as mock-based unit test in new `describe("Public Proxy API -- Security (unit)")` block:
  - Removed `it.skipIf(!gcpAvailable)` — now always runs
  - Added `vi.doMock("@/lib/storage", ...)` to stub `getPublicBucket` and `fileExists`
  - Uses dynamic import to load route handler with mocked storage
  - Cleans up mocks after test to avoid leaking

*Completed by work action (Route B)*

## Testing

**Tests run:** `npx vitest run src/app/api/public` + `npx vitest run` (full suite)
**Result:** ✓ 1229 passed, 2 skipped (GCP integration tests correctly skipped due to expired auth)

**Changes verified:**
- Test #3 (traversal) passes without GCP credentials
- Tests #1-2 correctly skip when GCP unavailable
- No regressions in full test suite (37/38 suites pass; 1 suite "failure" is pre-existing GCP auth expiry)

*Verified by work action*
