---
id: REQ-134
title: "Gate Vercel production deployment behind GitHub Actions CI"
status: completed
created_at: 2026-02-19T08:25:00-08:00
user_request: UR-040
claimed_at: 2026-02-19T11:00:00-08:00
route: C
completed_at: 2026-02-19T08:45:00-08:00
---

# Gate Vercel Production Deployment Behind GitHub Actions CI

## What
Reconfigure the deployment pipeline so that Vercel only deploys to production after GitHub Actions CI (build, lint, type check, gitleaks, CodeQL, npm audit) passes. Currently Vercel auto-deploys on push via its GitHub integration, racing ahead of CI and potentially shipping broken or insecure code.

## Context
- **Discovery:** During the /ship pipeline on 2026-02-19, a build stamp of `v02-19-2026_08:18` appeared on the live site while GitHub Actions CI was still running. The site was updated before security scans completed.
- **Risk:** Leaked secrets, type errors, lint failures, or security vulnerabilities could be deployed to production before CI catches them.
- **Current flow:** `git push` → Vercel deploys immediately AND GitHub Actions runs in parallel (no dependency)
- **Desired flow:** `git push` → GitHub Actions CI → only on success → Vercel deploys to production

## Implementation Plan

- [x] Step 1: Disable Vercel automatic Git deployments
- [x] Step 2: Add Vercel deploy step to GitHub Actions
- [x] Step 3: Update /ship pipeline documentation
- [ ] Step 4: Verify the new flow (deferred — requires pushing and observing CI)

## Assets
- `.github/workflows/ci.yml` — current CI workflow
- Vercel project: `prj_w6WtTr0Ae61aE2cW0GTEHaffs3kx`
- Vercel team: `team_lAFd8eLgRO9IuivB7YwxiO3m`

---
*Source: Discovered race condition during /ship pipeline — Vercel deployed before CI completed, bypassing security gates.*

---

## Triage

**Route: C** - Complex

**Reasoning:** Multi-system change spanning Vercel configuration, GitHub Actions CI workflow, GitHub secrets, and the /ship skill documentation. Requires integration between external services (Vercel deploy API + GitHub Actions) and careful ordering to avoid breaking the deploy pipeline.

**Planning:** Required

## Plan

### Approach: Disable Vercel Auto-Deploy + Add CI Deploy Job

**Current state:** Vercel GitHub integration auto-deploys on every push (racing CI). CI has two parallel jobs (`build-and-test`, `security-scan`) with no deploy step.

**Strategy:**
1. **Disable Vercel auto-deploy** via Dashboard (Settings > Git) — keeps preview deploys on PRs, only gates production
2. **Add GitHub secrets** — `VERCEL_TOKEN`, `VERCEL_ORG_ID`, `VERCEL_PROJECT_ID`
3. **Add `deploy` job to CI workflow** — `needs: [build-and-test, security-scan]`, gated by `if: push to main`, uses `vercel deploy --prod`
4. **Update /ship, /watch-deploy, /deploy-vercel commands** — remove Vercel auto-deploy polling, reflect unified CI+deploy pipeline

### Deploy Job Structure

```yaml
deploy:
  if: github.event_name == 'push' && github.ref == 'refs/heads/main'
  needs: [build-and-test, security-scan]
  runs-on: ubuntu-latest
  environment: production
  steps:
    - Checkout
    - Install Vercel CLI
    - Deploy with VERCEL_TOKEN/ORG_ID/PROJECT_ID env vars
    - Health check against /api/health
```

### File Changes

| File | Change |
|------|--------|
| `.github/workflows/ci.yml` | Add `deploy` job |
| `.claude/commands/ship.md` | Remove Vercel polling step, update to monitor CI+deploy |
| `.claude/commands/watch-deploy.md` | Update to reflect deploy is a CI job |
| `.claude/commands/deploy-vercel.md` | Strengthen manual-override warning |

### Manual Steps (User)
- **[Sam]** Disable auto-deploy for production branch in Vercel Dashboard
- **[Sam]** Create Vercel API token and add 3 GitHub secrets
- These MUST happen before pushing the CI workflow change

### Implementation Order
1. Manual: Vercel Dashboard + GitHub secrets (FIRST — before any push)
2. Code: CI workflow deploy job
3. Code: Update commands
4. Verify: Push and confirm gated deploy works

*Generated by Plan agent*

## Exploration

**CI Workflow** (`.github/workflows/ci.yml`): Two parallel jobs `build-and-test` and `security-scan`. No deploy job. Runs on push/PR to main. Build uploads `.next/standalone/` artifacts.

**Ship Command** (`.claude/commands/ship.md`): 9-step pipeline — test → commit → gitleaks → push → CI monitor → Vercel auto-deploy polling → health check → visual confirm → report. Step 6 polls `mcp__vercel__list_deployments` every 15s. Uses `allowed-tools` frontmatter.

**Watch Deploy** (`.claude/commands/watch-deploy.md`): Monitor-only, 8 steps. Same Vercel polling pattern. No git write operations.

**Deploy Vercel** (`.claude/commands/deploy-vercel.md`): Manual override using `deploy_to_vercel` MCP tool. Already has disclaimer about bypassing CI/CD.

**Vercel Config** (`web/vercel.json`): Minimal — only `functions.maxDuration: 60` for API tools. No git/deploy settings.

**Project IDs** (`web/.vercel/project.json`): `projectId: prj_w6WtTr0Ae61aE2cW0GTEHaffs3kx`, `orgId: team_lAFd8eLgRO9IuivB7YwxiO3m`, `projectName: samkirk-com-v3`.

**Key finding**: Ship.md Step 6 says "CI passing triggers Vercel auto-deploy" — this is inaccurate. Vercel currently deploys in parallel with CI via its GitHub integration, not gated by CI status.

*Generated by Explore agent*

## Implementation Summary

**Code changes:**
- `.github/workflows/ci.yml` — Added `deploy` job: `needs: [build-and-test, security-scan]`, gated by `if: push && refs/heads/main`, uses `vercel deploy --prod --yes`, includes 3-retry health check
- `.claude/commands/ship.md` — Updated description, removed Step 6 (Vercel auto-deploy polling), updated Step 5 to cover full CI+deploy pipeline (15-min timeout), renumbered Steps 7-9 → 6-8
- `.claude/commands/watch-deploy.md` — Updated description and intro, simplified to 7 steps reflecting deploy-as-CI-job, 15-min timeout
- `.claude/commands/deploy-vercel.md` — Changed opening to "EMERGENCY MANUAL OVERRIDE" with explicit note that auto-deploy is disabled

**Infrastructure changes (via CLI/API):**
- Vercel: Set `commandForIgnoringBuildStep` to `[ "$VERCEL_GIT_COMMIT_REF" = "main" ]` — skips auto-deploy on main, keeps preview deploys on PRs
- GitHub: Added 3 secrets — `VERCEL_TOKEN`, `VERCEL_ORG_ID`, `VERCEL_PROJECT_ID`

*Completed by work action (Route C)*

## Testing

**Tests run:** `npm test -- --run`
**Result:** ✓ All 1293 tests passing (40 test files)

**CI workflow validation:** YAML syntax valid, 3 jobs detected (`build-and-test`, `security-scan`, `deploy`), correct `needs` and `if` conditions

**Deferred verification:**
- [ ] Push and confirm Vercel does NOT auto-deploy on main
- [ ] Confirm GitHub Actions runs CI → deploy only on success
- [ ] Confirm failing CI prevents deployment

*Verified by work action*
