---
id: REQ-052
title: "Add --diff flag"
status: completed
created_at: 2026-02-13T18:00:00Z
user_request: UR-007
claimed_at: 2026-02-13T21:00:00Z
route: B
completed_at: 2026-02-13T21:10:00Z
related: [REQ-043]
batch: "test-results-phase-3"
source_step: "3.5"
source_doc: "docs/test-results-TODO.md"
blueprint_ref: "docs/test-results-BLUEPRINT.md"
model_hint: "Sonnet 4"
---

# Add --diff flag (Step 3.5)

## What
Add `--diff` flag that compares the two most recent test runs, showing status changes, pass/fail count deltas, and duration deltas.

## Checklist
- [x] Find two most recent archives
- [x] Compare: suites that changed status, pass/fail count deltas, duration deltas
- [x] Print side-by-side comparison
- [x] TEST: `npm run test:results -- --diff`

## Blueprint Guidance

| Flag | Behavior |
|------|----------|
| `--diff` | Compare latest two runs (status changes, count deltas) |

## Context
- **Document set**: test-results
- **Phase**: 3 — Remaining Viewer Flags
- **Blueprint**: See docs/test-results-BLUEPRINT.md for full design
- **Model recommendation**: Sonnet 4 (advisory — use if your tool supports model selection)

## Dependencies
Depends on REQ-043 (core viewer with parseSummaryTable). Phase 1 must be complete.

---
*Source: docs/test-results-TODO.md, Step 3.5*

---

## Triage

**Route: B** - Medium

**Reasoning:** Clear feature (--diff flag) but need to explore existing archive format, parseSummaryTable, and CLI patterns to implement correctly.

**Planning:** Not required

## Plan

**Planning not required** - Route B: Exploration-guided implementation

Rationale: The --diff flag has a well-defined outcome (compare two runs). Just need to discover how archives are stored and what parse functions exist.

*Skipped by work action*

## Exploration

- Main script: `web/scripts/test-results.ts` (817 lines)
- CLI already parses `--diff` → `args.diff: [string, string] | null` (line 120), stub at lines 754-757
- Archive dir: `do-work/archive/test-runs/` with timestamp dirs (YYYY-MM-DD_HH-MM-SS)
- `findLatestArchive()` returns newest dir, `findArchiveByPrefix()` for partial match
- `parseSummaryFrontmatter(content)` → `SummaryFrontmatter | null` (timestamp, overall, suites_run, etc.)
- `parseSummaryTable(content)` → `SuiteRow[]` (name, status, passed, failed, skipped, duration)
- ANSI colors available: `colorize()`, `ANSI.red/green/yellow/cyan/dim/bold`
- Helpers: `padRight()`, `padLeft()`, `formatTimestamp()`
- Column widths: COL_NAME=20, COL_STATUS=10, COL_PASS/FAIL/SKIP=8, COL_TIME=10
- 7 archives exist for testing; getDiffArgs() already parses two optional positional args after --diff

*Generated by Explore agent*

## Implementation Summary

- Added `findTwoLatestArchives()`, `parseDurationMs()`, `formatDelta()`, `formatDurationDelta()`, `loadRunData()`, `printDiffView()` functions
- Replaced stub at line 754-757 with full diff view handler
- Supports both bare `--diff` (auto-detect two latest) and `--diff run1 run2` (explicit)
- Color-coded output: green for improvements, red for regressions, dim for unchanged
- Handles edge cases: suites present in only one run (marked `(new)` or `(gone)`), fewer than 2 archives

*Completed by work action (Route B)*

## Testing

**Tests run:** `npx tsx scripts/test-results.ts --diff`
**Result:** Correct output showing status transitions, pass/fail/skip deltas, and duration deltas across 4 suites

*Verified by work action*
